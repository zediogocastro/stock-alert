name: Scheduled Report

on:
  schedule:
    - cron: "0 11 * * 1-5"   # Weekdays at 11:00 UTC
  workflow_dispatch:

env:
  ENABLE_REPORT_JOB: ${{ vars.ENABLE_REPORT_JOB }}
  POETRY_VERSION: "1.8.3"

jobs:
  generate-report:
    name: Generate Scheduled Stock Report
    runs-on: ubuntu-24.04

    if: |
      (github.event_name == 'schedule' && vars.ENABLE_REPORT_JOB == 'true') ||
      github.event_name == 'workflow_dispatch'
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache Poetry
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/bin
            ~/.local/share/pypoetry
          key: poetry-${{ runner.os }}-${{ env.POETRY_VERSION }}

      - name: Install Poetry
        if: "! command -v poetry &> /dev/null"
        run: |
          curl -sSL https://install.python-poetry.org | python3 - --version $POETRY_VERSION
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache virtual environment
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Run stock check script
        run: poetry run python scripts/run_stock_check.py

      - name: List generated reports (debug)
        run: ls -la reports || echo "reports dir missing"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: stock-reports
          path: reports/
          retention-days: 7

      - name: Show stock report in logs
        run: |
          echo "::group::ðŸ“Š Stock Report"
          cat reports/stock_report.md
          echo "::endgroup::"
